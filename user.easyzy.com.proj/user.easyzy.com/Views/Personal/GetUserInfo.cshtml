
<div style="font-size:16px;">
    <table class="tab-default">
        <tr>
            <td class="tright">用户名：</td>
            <td class="tleft">@ViewBag.UserInfo.UserName</td>
            <td class=""></td>
        </tr>
        <tr>
            <td class="tright">真实姓名：</td>
            <td class="tleft"><input type="text" id="TrueNameInput" value="@ViewBag.UserInfo.TrueName" /></td>
            <td class=""><a href="javascript:void(0);" class="truenamebtn icoedit save" title="保存"></a>@*<label class="cedit">（5位以内。修改后，您提交作业时将会默认使用此姓名）</label>*@</td>
        </tr>
        <tr>
            <td class="tright">学校信息：</td>
            <td class="tleft">
                @*<b id="ClassB">@ViewBag.UserInfo.Class</b>
                <input class="classinfo" type="text" id="ClassInput" value="" style="display:none" />*@
                <div class="tpanal">
                    <p class="panal_title">学校信息设置之后不能修改，请谨慎选择！</p>
                    
                    <div class="tselect">
                        @if (ViewBag.UserInfo.SchoolId == 0)
                        {
                            <label class="tselect_tip">省：</label>
                            <select class="pselecter short">
                                <option value="0"></option>
                                @foreach (var p in ViewBag.Provinces)
                                {
                                    <option value="@p.Key">@p.Value</option>
                                }
                            </select>
                            <label class="tselect_tip">市：</label>
                            <select class="cselecter short">
                                <option value="0"></option>
                            </select>
                            <label class="tselect_tip">区：</label>
                            <select class="dselecter long">
                                <option value="0"></option>
                            </select>
                            
                            <div class="ss">
                                <label>学校：</label>
                                <input class="schinput long" placeholder="在结果中搜索、点右边箭头展开" />
                                <select class="sselecter long" style="position:relative;">
                                    <option value="0"></option>
                                </select>
                            </div>
                        }
                        else
                        {
                            <label class="tselect_tip">省：</label>
                            <select disabled class="pselecter short">
                                <option value="@ViewBag.UserInfo.ProvinceId">@ViewBag.UserInfo.ProvinceName</option>
                            </select>
                            <label class="tselect_tip">市：</label>
                            <select disabled class="cselecter short">
                                <option value="@ViewBag.UserInfo.CityId">@ViewBag.UserInfo.CityName</option>
                            </select>
                            <label class="tselect_tip">区：</label>
                            <select disabled class="dselecter long">
                                <option value="@ViewBag.UserInfo.DistrictId">@ViewBag.UserInfo.DistrictName</option>
                            </select>
                            <div>
                                <label>学校：</label>
                                <select disabled class="sselecter long">
                                    <option value="@ViewBag.UserInfo.SchoolId">@ViewBag.UserInfo.SchoolName</option>
                                </select>
                            </div>
                        }
                    </div>
                </div>
            </td>
            <td>
                @if (ViewBag.UserInfo.SchoolId == 0)
                {
                    <a href="javascript:void(0);" class="schoolbtn icoedit save" title="保存"></a>
                }
                else
                {
                    <a href="javascript:void(0);" class="applybtn icoapply" onclick="RequestModify();" title="提交修改申请"></a>
                }
            </td>
        </tr>
        <tr>
            <td class="tright">班级信息：</td>
            <td class="tleft">
                <div class="tpanal">
                    年级：
                    <select class="gselecter short">
                        <option value="0"></option>
                        @foreach (var c in ViewBag.Grades)
                        {
                            <option value="@c.Key">@c.Value</option>
                        }
                    </select>
                    班级：
                    <select class="clsselecter short">
                        <option value="0"></option>
                        @for (int i = 1; i < 100; i++)
                        {
                            <option value=@i>@(i)班</option>
                        }
                    </select>
                </div>
            </td>
            <td>
                <a href="javascript:void(0);" class="classbtn icoedit save" title="保存"></a>
            </td>
        </tr>
        
        <tr>
            <td class="tright">作业收费：</td>
            <td class="tleft">0元</td>
            <td class="">暂未开放<br/>@*（作为对您提供优质内容的回馈，学生只有付款后才能打开/查看您新建的作业）*@</td>
        </tr>
        <tr>
            <td class="tright">关注了谁：</td>
            <td class="tleft relate">
                @if (ViewBag.RelateUser != null)
                {
                    foreach (var u in ViewBag.RelateUser)
                    {
                        <a href="javascript:void(0);" data-bind="@u.RUserId" class="ql">@(u.RUserName)【@(u.RTrueName)】</a>
                        <a href="javascript:void(0);" data-bind="@u.RUserId" class="del" onclick="CancelRelate(@u.RUserId);"></a>
                    }
                }
            </td>
            <td><a href="javascript:void(0);" class="icoadd" title="添加" onclick="AddRelate();"></a></td>
        </tr>
        <tr>
            <td class="tright">被谁关注：</td>
            <td class="tleft berelated">
                <p class="panal_title">只有关注了您的人，才有权打开您新建的作业！锁定之后任何人都不能再关注您。</p>
                <div style="height:50px;">
                    @if (ViewBag.BeRelatedUser != null)
                    {
                        foreach (var u in ViewBag.BeRelatedUser)
                        {
                            <label href="javascript:void(0);" class="ql">@(u.UserName)【@(u.TrueName)】</label>
                        }
                    }
                    else
                    {
                        <label>暂无</label>
                    }
                </div>
            </td>
            <td>
                @if (ViewBag.Extend == null || !ViewBag.Extend.Locked)
                {
                    <a href="javascript:void(0);" class="icolock lock" title="未锁定 可被关注"></a>
                }
                else
                {
                    <a href="javascript:void(0);" class="icolock lock active" title="已锁定 不能被关注"></a>
                }
            </td>
        </tr>
    </table>
</div>
<div class="Relate st-roster" style="display:none; padding: 20px 10px; height:500px;">
    <img src="/Images/close.png" class="popclose" />
    <div class="queryrelate">
        <input id="keywords" placeholder="模糊搜索（用户名/真实姓名）" /><a class="btn" onclick="query();">查询</a>
    </div>
    <div class="chooserelate">
        <div style="color:red; padding-bottom:5px;">（最多返回20条记录）</div>
        <table border="0" cellspacing="1" cellpadding="0" class="tab-default">
            <thead>
                <tr>
                    <th>序号</th>
                    <th>用户名</th>
                    <th>真实姓名</th>
                    <th>学校</th>
                    <th>年级</th>
                    <th>班级</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tbody2"></tbody>
        </table>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        if ("@ViewBag.UserInfo.GradeId" != "0") {
            $(".gselecter").val("@ViewBag.UserInfo.GradeId");
        }

        if ("@ViewBag.UserInfo.ClassId" != "0") {
            $(".clsselecter").val("@ViewBag.UserInfo.ClassId");
        }
    })

    $(".truenamebtn").on("click", function () {
        var truename = $("#TrueNameInput").val();
        if (truename.length > 5) {
            dialogAlert("真实姓名长度不能大于5！");
            return;
        }

        $.post("/personal/UpdateTrueName",
            { trueName: truename },
            function (data) {
                if (data == "0") {
                    dialogAlert("修改成功！");
                }
                else {
                    dialogAlert("修改失败！");
                }
            })
    })

    $(".pselecter").on("change", function () {
        $(".dselecter").html("<option value='0'></option>");
        $(".sselecter").html("<option value='0'></option>");
        var pid = $(this).val();
        if (pid == 0) {
            $(".cselecter").html("<option value='0'></option>");
            return;
        }
        var html = "<option value='0'></option>";
        $.post("/personal/GetCites",
            { provinceId: pid },
            function (data) {
                for (var i = 0; i < data.length; i++) {
                    html += "<option value='" + data[i].CityId + "'>" + data[i].CityName + "</option>";
                }
                $(".cselecter").html(html);
            })
    })

    $(".cselecter").on("change", function () {
        $(".sselecter").html("<option value='0'></option>");
        var cid = $(this).val();
        if (cid == 0) {
            $(".dselecter").html("<option value='0'></option>");
            return;
        }
        var html = "<option value='0'></option>";
        $.post("/personal/GetDistricts",
            { cityId: cid },
            function (data) {
                for (var i = 0; i < data.length; i++) {
                    html += "<option value='" + data[i].DistrictId + "'>" + data[i].DistrictName + "</option>";
                }
                $(".dselecter").html(html);
            })
    })

    $(".dselecter").on("change", function () {
        searchSchools();
        showSchools();
    })

    var cur_Schools = [];

    var searchSchools = function () {
        cur_Schools = [];
        var did = $(".dselecter").val();
        if (did == 0) {
            $(".sselecter").html("<option value='0'></option>");
            return;
        }
        
        $.ajax({
            url: "/personal/SearchSchools",
            type: "post",
            async: false,
            data: { districtId: did, keyWords: "" },
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    cur_Schools.push(data[i].SchoolId + "_!" + data[i].SchoolName);
                }
            }
        })
    }

    //根据搜索出来的学校数组，结合搜索词，重置下拉框中显示的学校
    var showSchools = function () {
        if (cur_Schools.length == 0) return;
        var keyWords = $(".schinput").val();
        
        var html = "<option value='0'></option>";
        if (keyWords == "") {
            for (var i = 0; i < cur_Schools.length; i++) {
                html += "<option value='" + cur_Schools[i].split("_!")[0] + "'>" + cur_Schools[i].split("_!")[1] + "</option>";
            }
        }
        else {
            for (var i = 0; i < cur_Schools.length; i++) {
                var ss = cur_Schools[i].split("_!");
                if (ss[1].indexOf(keyWords) != -1) {
                    html += "<option value='" + ss[0] + "'>" + ss[1] + "</option>";
                }
            }
        }
        $(".sselecter").html(html);
    }

    $(".schinput").focus(function () {
        var did = $(".dselecter").val();
        if (!did || did == 0) {
            $(".dselecter").css("border", "1px solid red");
            return;
        }
    })

    //从下拉框中搜索学校
    $(".schinput").on("change", function () {
        showSchools();
    })

    //从下拉框中搜索到学校并选中
    $(".schinput").on("blur", function () {
        $(".dselecter").css("border", "1px solid #dfdfdf");
    })

    $(".sselecter").on("change", function () {
        $(".schinput").val($(this).find("option:selected").text());
    })

    //学校修改
    $(".schoolbtn").on("click", function () {
        var pid = $(".pselecter").val();
        var cid = $(".cselecter").val();
        var did = $(".dselecter").val();
        var sid = $(".sselecter").val();

        if (!sid || sid == 0) {
            dialogAlert("请从学校下拉框中选择学校！");
            return false;
        }

        $.post("/personal/UpdateUserSchool",
            { provinceId: pid, cityId: cid, districtId: did, schoolId: sid },
            function (data) {
                if (data == "0") {
                    $(".pselecter").attr("disabled", true);
                    $(".cselecter").attr("disabled", true);
                    $(".dselecter").attr("disabled", true);
                    $(".sselecter").attr("disabled", true);
                    $(".schinput").attr("disabled", true);
                    dialogAlert("修改成功！");
                }
                else {
                    dialogAlert("修改失败！");
                }
            })
    })

    //班级修改
    $(".classbtn").on("click", function () {
        var gid = $(".gselecter").val();
        var clsid = $(".clsselecter").val();
        
        $.post("/personal/UpdateUserClass",
            { gradeId: gid, classId: clsid },
            function (data) {
                if (data == "0") {
                    dialogAlert("修改成功！");
                }
                else {
                    dialogAlert("修改失败！");
                }
            })
    })

    //添加关注
    var AddRelate = function () {
        $("#keywords").val("");
        $("#tbody2").html("");
        $(".Relate").show();
        $('input').placeholder();
        $('body').prepend('<div class="shade fixed1"></div>');
    }

    $(".st-roster .popclose").click(function () {
        $(".Relate").hide();
        $(".shade").hide();
    })

    var query = function () {
        var html = "";
        $("#tbody2").html("<div><img style='vertical-align: middle;' src='/images/loader.gif'><b>正在查询中……</b></div>");
        var keywords = $("#keywords").val();
        $.post("/personal/SearchUser",
            { keyWords: keywords },
            function (json) {
                if (json.length != 0) {
                    for (var i = 0; i < json.length; i++) {
                        html += "<tr><td>" + (i + 1) + "</td><td>" + json[i].UserName + "</td><td>" + json[i].TrueName + "</td><td>" + json[i].SchoolName + "</td><td>" + json[i].GradeName + "</td><td>" + json[i].ClassName + "</td>";
                        if (!json[i].Locked) {
                            html += "<td><a href='javascript:void(0);' style='color:royalblue' onclick=\"relate('" + json[i].Id + "','" + json[i].UserName + "','" + json[i].TrueName + "'); \">关注</a></td >";
                        }
                        else {
                            html += "<td title='被锁定，不能关注'>-</td >";
                        }
                        html += "</tr > ";
                    }
                    $("#tbody2").html(html);
                }
                else {
                    $("#tbody2").html("<tr><td colspan='6'>没有查询到用户！</td></tr>");
                }
            })
    }

    var relate = function (userid, username, truename)
    {
        $.post("/personal/Relate",
            { userId: userid },
            function (data) {
                if (data == "") {
                    $("td.relate").prepend("<a href='javascript:void(0);' data-bind='" + userid + "' class='ql' onclick='QueryRZy(" + userid + ");'>" + username + "【" + truename + "】</a><a href='javascript:void(0);' data-bind='" + userid + "' class='del' onclick=\"CancelRelate(" + userid + ");\"></a>");
                    $(".Relate").hide();
                    $(".shade").hide();
                }
                else {
                    alert(data);
                }
            })
    }

    var CancelRelate = function (userid)
    {
        Cancel_Data.UserId = userid;
        dialogConfirm("确定要取消关注吗？", CancelRelateOK, "");
    }

    var Cancel_Data = {
        UserId: 0
    }

    var CancelRelateOK = function () {
        $.post("/personal/CancelRelate",
            { userId: Cancel_Data.UserId },
            function (data) {
                if (data == "") {
                    $(".relate a").each(function () {
                        if ($(this).attr("data-bind") == Cancel_Data.UserId) {
                            $(this).hide();
                        }
                    })
                }
                else {
                    dialogAlert(data);
                }
            })
    }

    $(".lock").on("click", function () {
        var t = $(this);
        if (t.hasClass("active")) {
            $.post("/personal/UnLock",
                {},
                function (data) {
                    if (data == "0") {
                        t.removeClass("active");
                        t.attr("title", "未锁定 可被关注");
                    }
                    else {
                        dialogAlert("解锁失败！");
                    }
                })
        }
        else {
            $.post("/personal/Lock",
                {},
                function (data) {
                    if (data == "0") {
                        t.addClass("active");
                        t.attr("title", "已锁定 不能被关注");
                    }
                    else {
                        dialogAlert("锁定失败！");
                    }
                })
        }
    })
</script>